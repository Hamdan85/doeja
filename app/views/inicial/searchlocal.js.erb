<% if @alert %>
    flash_notice('<%= escape_javascript(@alert) %>');
<% end %>

Gmaps.map.listen_to_markers = function(markers){
    if (markers.length == 1) {
        Gmaps.map.auto_zoom = false;
        setTimeout(function() { Gmaps.map.serviceObject.setZoom(16);}, 50);
    } else {
        Gmaps.map.adjustMapToBounds();
    }
    bounceNearest(markers);
    addlisteners(markers, 0);
}

function toggleBounce(marker) {

    if (marker.serviceObject.getAnimation() != null) {
        marker.serviceObject.setAnimation(null);
    } else {
        marker.serviceObject.setAnimation(google.maps.Animation.BOUNCE);
    }
}

function addlisteners(markers,recursive) {

    if (recursive <= markers.length-1) {
        google.maps.event.addListener(markers[recursive].serviceObject, 'mouseover', function () {
            markers[recursive].infowindow.open(Gmaps.map.map, markers[recursive].serviceObject);
        });


        google.maps.event.addListener(markers[recursive].serviceObject, 'mouseout', (function () {
            markers[recursive].infowindow.close(Gmaps.map.map, markers[recursive].serviceObject);
        }));
    }

    if (recursive != (markers.length)) {

            addlisteners(markers, recursive+1);
    }
}

function bounceNearest(markers) {
    if (markers.length > 1 ) {
        var mMarker = 0;
        var distMarker = 9999999999999;
        for (i=0; i<(markers.lenght-1); i++) {
            if (marker.distance < distMarker) {
                mMarker = i;
                distMarker = marker.distance
            }
        }
        Gmaps.map.markers[mMarker].picture = '/assets/rmarker.png'
        Gmaps.map.callback();
        toggleBounce(Gmaps.map.markers[mMarker]);
        google.maps.event.addListener(Gmaps.map.markers[mMarker].serviceObject, 'mouseOver', function () {
            toggleBounce(Gmaps.map.markers[mMarker]);
        });
    }
}

clearFields();
var new_markers = <%= raw @receiving  %>;
setTimeout(function () {
    Gmaps.map.replaceMarkers(new_markers);
    Gmaps.map.listen_to_markers(new_markers);
}, 200);

